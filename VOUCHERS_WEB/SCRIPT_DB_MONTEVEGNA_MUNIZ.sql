create DATABASE VOUCHERS_WEB_DB
GO
USE VOUCHERS_WEB_DB
GO
--SOLO CIUDADES DE BUENOS AIRES YA QUE NO SE ESPECIFICA EN EL ENUNCIADO
CREATE TABLE LOCALIDADES(
COD_POSTAL INT NOT NULL PRIMARY KEY CHECK(COD_POSTAL>0),
NOMBRE VARCHAR(30) NOT NULL
)
GO
CREATE TABLE CLIENTES(
DNI INT NOT NULL PRIMARY KEY CHECK(DNI>0),
NOMBRE VARCHAR(30) NOT NULL,
APELLIDO VARCHAR(30) NOT NULL,
NROCALLE SMALLINT NOT NULL CHECK(NROCALLE>0),
CALLE VARCHAR(30) NOT NULL,
COD_POSTAL INT NOT NULL FOREIGN KEY REFERENCES LOCALIDADES(COD_POSTAL),
TELEFONO INT NOT NULL CHECK(TELEFONO>0),
EMAIL VARCHAR(30) NOT NULL
)
GO
CREATE TABLE PRODUCTOS(
ID INT NOT NULL PRIMARY KEY IDENTITY(1,1),
NOMBRE VARCHAR(30) NOT NULL,
URLIMAGEN VARCHAR(1000) NOT NULL
)
GO
CREATE TABLE SORTEOS(
ID INT NOT NULL PRIMARY KEY IDENTITY(1,1),
NOMBRE VARCHAR(30) NULL,
FECHA_INI SMALLDATETIME NOT NULL,
FECHA_FIN SMALLDATETIME NOT NULL,
CHECK(FECHA_FIN>FECHA_INI)
)

GO
CREATE TABLE VOUCHERS(
ID VARCHAR(8) NOT NULL PRIMARY KEY,
FECHA DATETIME NOT NULL,
ACTIVO BIT NOT NULL,
ID_SORTEO INT NOT NULL FOREIGN KEY REFERENCES SORTEOS(ID),
ID_PROD_SELEC INT NULL FOREIGN KEY REFERENCES PRODUCTOS(ID)
)
GO
CREATE TABLE COMPRAS(
ID BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
ID_PRODUCTO INT NOT NULL FOREIGN KEY REFERENCES PRODUCTOS(ID),
ID_VOUCHER VARCHAR(8) NOT NULL FOREIGN KEY REFERENCES VOUCHERS(ID),
FECHA DATETIME NOT NULL
)
GO
CREATE TABLE NOCLIENTES(
ID BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
ID_COMPRA BIGINT NOT NULL FOREIGN KEY REFERENCES COMPRAS(ID)
)
GO
CREATE TABLE COMPRAS_X_CLIENTE(
ID_COMPRA BIGINT NOT NULL FOREIGN KEY REFERENCES COMPRAS(ID),
ID_CLIENTE INT NOT NULL FOREIGN KEY REFERENCES CLIENTES(DNI),
PRIMARY KEY(ID_COMPRA,ID_CLIENTE)
)
GO
CREATE TABLE PREMIOS(
ID INT NOT NULL PRIMARY KEY IDENTITY(1,1),
ID_PRODUCTO INT NOT NULL FOREIGN KEY REFERENCES PRODUCTOS(ID),
ID_VOUCHER VARCHAR(8) NOT NULL FOREIGN KEY REFERENCES VOUCHERS(ID),
ACTIVO BIT NOT NULL
)
GO

--VOUCHERS

--SP PARA BUSCAR VOUCHER POR ID
--si el id es igual al de db, esta activo,fue comprado, no fue utilizado antes y esta en el sorteo actual
CREATE PROCEDURE SP_BUSCAR_VOUCHER_X_ID
(
@ID_VOUCHER VARCHAR(8)
)
AS
BEGIN

SELECT V.ID,V.FECHA,V.ACTIVO,V.ID_SORTEO,V.ID_PROD_SELEC FROM VOUCHERS AS V 
INNER JOIN COMPRAS AS C ON V.ID=C.ID_VOUCHER
INNER JOIN SORTEOS AS S ON V.ID_SORTEO=S.ID
WHERE @ID_VOUCHER=V.ID AND V.ACTIVO=1 AND V.FECHA=C.FECHA AND V.FECHA BETWEEN CAST(S.FECHA_INI AS DATETIME) AND CAST(S.FECHA_FIN AS DATETIME)

END

GO

--INSERTA EL ID DEL PRODUCTO SELECCIONADO EN EL VOUCHER GANADOR USADO Y LO DA DE BAJA
CREATE PROCEDURE SP_BAJA_VOUCHER
(@ID_VOUCHER VARCHAR(8),
@ID_PROD INT)
AS
BEGIN

UPDATE VOUCHERS SET ID_PROD_SELEC=@ID_PROD , ACTIVO=0
WHERE ID=@ID_VOUCHER

END

--PRODUCTOS
GO
-- SP PARA LISTAR LOS PRODUCTOS DEL VOUCHER GANADOR
CREATE PROCEDURE SP_LISTAR_PROD_WIN_X_VOUCHER
(
@ID_VOUCHER VARCHAR(8)
)
AS
BEGIN

SELECT P.ID,P.NOMBRE,P.URLIMAGEN FROM PRODUCTOS AS P 
INNER JOIN PREMIOS AS PR ON P.ID=PR.ID_PRODUCTO
WHERE @ID_VOUCHER=PR.ID_VOUCHER

END

--CLIENTES

--CARGAR CLIENTE
--si la localidad no existe, la agrega
CREATE PROCEDURE SP_CARGAR_CLIENTE
(
@DNI INT,
@NOMBRE VARCHAR(30),
@APELLIDO VARCHAR(30),
@NROCALLE SMALLINT,
@CALLE VARCHAR(30),
@CODPOSTAL INT,
@TELEFONO INT,
@EMAIL VARCHAR(30)
)
AS
BEGIN

INSERT INTO CLIENTES (DNI,NOMBRE,APELLIDO,NROCALLE,CALLE,COD_POSTAL,TELEFONO,EMAIL)
VALUES(@DNI,@NOMBRE,@APELLIDO,@NROCALLE,@CALLE,@CODPOSTAL,@TELEFONO,@EMAIL)

END

--SP PARA SABER SI ESTA REGISTRADO EL CLIENTE
CREATE PROCEDURE SP_VERIFICAR_CLIENTE
(
@DNI INT
)
AS
BEGIN

DECLARE @BIT BIT

SELECT @BIT=0

IF CAST((SELECT DNI FROM CLIENTES WHERE @DNI=DNI) AS BIT )=1
BEGIN
SELECT @BIT=1
END

RETURN @BIT

END

--SP PARA MODIFICAR EL CLIENTE
CREATE PROCEDURE SP_MODIFICAR_CLIENTE
(@DNI INT,
@NOMBRE VARCHAR(30),
@APELLIDO VARCHAR(30),
@NROCALLE SMALLINT,
@CALLE VARCHAR(30),
@CODPOSTAL INT,
@TELEFONO INT,
@EMAIL VARCHAR(30)
)
AS
BEGIN 

UPDATE CLIENTES SET DNI=@DNI,NOMBRE=@NOMBRE,
APELLIDO=@APELLIDO,NROCALLE=@NROCALLE,CALLE=@CALLE,
COD_POSTAL=@CODPOSTAL,TELEFONO=@TELEFONO,EMAIL=@EMAIL
WHERE @DNI=DNI

END

--SP PARA BUSCAR EL CLIENTE POR SU DNI
CREATE PROCEDURE SP_BUSCAR_CLIENTE_X_DNI
(@DNI INT)
AS
BEGIN

SELECT * FROM CLIENTES WHERE @DNI=DNI

END

--SP PARA BUSCAR LOCALIDAD POR CODIGO POSTAL
CREATE PROCEDURE SP_BUSCAR_LOC_X_CODPOSTAL
(
@CODPOSTAL INT
)AS
BEGIN 
SELECT NOMBRE FROM LOCALIDADES WHERE COD_POSTAL=@CODPOSTAL
END
